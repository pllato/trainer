<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELC English Speaking Trainer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        select {
            padding: 10px;
            font-size: 16px;
            margin: 10px;
        }
        #log {
            text-align: left;
            margin-top: 20px;
            padding: 10px;
            background: #e8e8e8;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
        }
        .status {
            font-size: 18px;
            margin: 10px 0;
        }
        .examples {
            margin: 20px 0;
            text-align: left;
        }
        #currentStructure {
            font-size: 18px;
            margin: 15px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ELC English Speaking Trainer</h1>
        <select id="tenseSelect">
            <option value="present">Present Simple</option>
            <!-- Add more tenses later -->
        </select>
        <select id="structureSelect">
            <option value="I _______ .">I _______ .</option>
            <option value="He/She/It _______s .">He/She/It _______s .</option>
            <option value="We/You/They _______ .">We/You/They _______ .</option>
            <option value="I don’t _______ .">I don’t _______ .</option>
            <option value="He/She/It doesn’t _______ .">He/She/It doesn’t _______ .</option>
            <option value="We/You/They don’t _______ .">We/You/They don’t _______ .</option>
            <option value="Do I _______ ?">Do I _______ ?</option>
            <option value="Does he/she/it _______ ?">Does he/she/it _______ ?</option>
            <option value="Do we/you/they _______ ?">Do we/you/they _______ ?</option>
            <option value="Yes, I _______ .">Yes, I _______ .</option>
            <option value="Yes, he/she/it _______s .">Yes, he/she/it _______s .</option>
            <option value="No, I don’t _______ .">No, I don’t _______ .</option>
            <option value="No, he/she/it doesn’t _______ .">No, he/she/it doesn’t _______ .</option>
            <option value="Where do I _______ ?">Where do I _______ ?</option>
            <option value="What does he/she/it _______ ?">What does he/she/it _______ ?</option>
            <option value="When do we/you/they _______ ?">When do we/you/they _______ ?</option>
        </select>
        <div class="examples">
            <h3>Examples of verbs to use:</h3>
            <p>work, play, eat, run, study, walk, talk, read, write, drink</p>
        </div>
        <div id="currentStructure">Select a structure to start.</div>
        <button id="startButton">Start Practice</button>
        <div class="status" id="status">Correct: 0/10</div>
        <div class="status" id="listening">Press start to begin...</div>
        <div id="log">
            <h3>Practice Log:</h3>
            <div id="logEntries"></div>
        </div>
    </div>

    <script>
        const tenseSelect = document.getElementById('tenseSelect');
        const structureSelect = document.getElementById('structureSelect');
        const startButton = document.getElementById('startButton');
        const status = document.getElementById('status');
        const listening = document.getElementById('listening');
        const logEntries = document.getElementById('logEntries');
        const currentStructure = document.getElementById('currentStructure');

        let correctCount = 0;
        let recognition = null;
        let isListening = false;
        let saidSentences = new Set();
        let currentVerbSlot = '';

        // Update the displayed structure
        function updateStructure() {
            const structure = structureSelect.value;
            currentStructure.textContent = structure;
            currentVerbSlot = structure;
        }

        // Initialize speech recognition
        function initSpeechRecognition() {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onresult = (event) => {
                const spokenSentence = event.results[0][0].transcript.trim().toLowerCase();
                listening.textContent = 'Processing: ' + spokenSentence;
                checkSentence(spokenSentence);
            };

            recognition.onend = () => {
                if (isListening && correctCount < 10) {
                    recognition.start();
                    listening.textContent = 'Listening...';
                } else {
                    isListening = false;
                    listening.textContent = 'Stopped. Press start to begin...';
                    startButton.textContent = 'Start Practice';
                }
            };

            recognition.onerror = (event) => {
                listening.textContent = 'Error occurred: ' + event.error;
                isListening = false;
                startButton.textContent = 'Start Practice';
            };
        }

        // Check if the spoken sentence matches the structure and is correct
        function checkSentence(spokenSentence) {
            const tense = tenseSelect.value;
            let isCorrect = false;
            let logMessage = '';

            if (tense === 'present') {
                isCorrect = checkPresentSimpleSentence(spokenSentence, currentVerbSlot);
            }

            if (saidSentences.has(spokenSentence)) {
                logMessage = `Repeat: "${spokenSentence}"`;
            } else if (isCorrect) {
                correctCount++;
                saidSentences.add(spokenSentence);
                logMessage = `Correct: "${spokenSentence}"`;
                status.textContent = `Correct: ${correctCount}/10`;
            } else {
                logMessage = `Incorrect: "${spokenSentence}" (wrong form or structure)`;
            }

            // Add to log
            const logEntry = document.createElement('p');
            logEntry.textContent = logMessage;
            logEntries.prepend(logEntry);

            // Stop if 10 correct sentences are reached
            if (correctCount >= 10) {
                isListening = false;
                recognition.stop();
                listening.textContent = 'Congratulations! 10 correct sentences achieved!';
                startButton.textContent = 'Restart Practice';
            }
        }

        // Check if the spoken sentence matches the Present Simple structure
        function checkPresentSimpleSentence(spokenSentence, structure) {
            // Helper to check if a word is a valid base verb
            function isValidBaseVerb(verb) {
                const pastTenseIndicators = ['ed', 'was', 'were', 'went', 'did'];
                if (!/^[a-z]+$/.test(verb)) return false;
                return !pastTenseIndicators.some(indicator => verb === indicator || verb.endsWith(indicator));
            }

            // Split the spoken sentence into words
            const spokenWords = spokenSentence.split(/\s+/);
            const structureWords = structure.toLowerCase().split(/\s+/);

            // Extract the expected position of the verb (where _______ is)
            let verbPosition = structureWords.indexOf('_______');
            if (verbPosition === -1) return false;

            // Adjust structure words to exclude punctuation for length comparison
            const structureWordsWithoutPunctuation = structureWords.filter(word => word !== '.' && word !== '?');
            const expectedLength = structureWordsWithoutPunctuation.length;

            // Check if the spoken sentence has at least the expected number of words (excluding punctuation)
            if (spokenWords.length < expectedLength - 1) return false;

            // Extract the spoken verb at the expected position
            const spokenVerb = spokenWords[verbPosition];

            // Verify the fixed parts of the sentence match
            let structureMatches = true;
            for (let i = 0; i < structureWords.length; i++) {
                if (i === verbPosition) continue; // Skip the verb slot
                if (structureWords[i] === '.' || structureWords[i] === '?') continue; // Skip punctuation

                let expectedWord = structureWords[i];
                let spokenWord = spokenWords[i] || '';

                // Handle special characters (e.g., "don’t" vs "don't")
                expectedWord = expectedWord.replace(/[^a-z]/g, '');
                spokenWord = spokenWord.replace(/[^a-z]/g, '');

                if (expectedWord && expectedWord !== spokenWord) {
                    structureMatches = false;
                    break;
                }
            }

            if (!structureMatches) return false;

            // Validate the verb form based on the structure
            const baseVerbStructures = [
                'i _______ .',
                'we/you/they _______ .',
                'i don’t _______ .',
                'he/she/it doesn’t _______ .',
                'we/you/they don’t _______ .',
                'do i _______ ?',
                'does he/she/it _______ ?',
                'do we/you/they _______ ?',
                'no, i don’t _______ .',
                'no, he/she/it doesn’t _______ .',
                'where do i _______ ?',
                'what does he/she/it _______ ?',
                'when do we/you/they _______ ?'
            ];

            const verbSStructures = [
                'he/she/it _______s .',
                'yes, he/she/it _______s .'
            ];

            const yesBaseVerbStructures = [
                'yes, i _______ .'
            ];

            structure = structure.toLowerCase();
            if (baseVerbStructures.includes(structure)) {
                return isValidBaseVerb(spokenVerb) && !spokenVerb.endsWith('s') && !spokenVerb.endsWith('es');
            } else if (verbSStructures.includes(structure)) {
                return isValidBaseVerb(spokenVerb.replace(/(s|es)$/, '')) && (spokenVerb.endsWith('s') || spokenVerb.endsWith('es'));
            } else if (yesBaseVerbStructures.includes(structure)) {
                return isValidBaseVerb(spokenVerb) && !spokenVerb.endsWith('s') && !spokenVerb.endsWith('es');
            }

            return false;
        }

        // Event listeners
        tenseSelect.addEventListener('change', () => {
            correctCount = 0;
            status.textContent = 'Correct: 0/10';
            saidSentences.clear();
            logEntries.innerHTML = '';
            updateStructure();
            if (isListening) {
                recognition.stop();
                isListening = false;
                startButton.textContent = 'Start Practice';
                listening.textContent = 'Press start to begin...';
            }
        });

        structureSelect.addEventListener('change', () => {
            updateStructure();
            correctCount = 0;
            status.textContent = 'Correct: 0/10';
            saidSentences.clear();
            logEntries.innerHTML = '';
            if (isListening) {
                recognition.stop();
                isListening = false;
                startButton.textContent = 'Start Practice';
                listening.textContent = 'Press start to begin...';
            }
        });

        startButton.addEventListener('click', () => {
            if (!isListening) {
                if (!recognition) initSpeechRecognition();
                isListening = true;
                recognition.start();
                startButton.textContent = 'Stop Practice';
                listening.textContent = 'Listening...';
            } else {
                isListening = false;
                recognition.stop();
                startButton.textContent = 'Start Practice';
                listening.textContent = 'Stopped. Press start to begin...';
            }
        });

        // Initialize structure
        updateStructure();
    </script>
</body>
</html>
