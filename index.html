<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELC English Speaking Trainer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        select {
            padding: 10px;
            font-size: 16px;
            margin: 10px;
            width: 300px;
        }
        #log {
            text-align: left;
            margin-top: 20px;
            padding: 10px;
            background: #e8e8e8;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
        }
        .status {
            font-size: 18px;
            margin: 10px 0;
        }
        .examples {
            margin: 20px 0;
            text-align: left;
        }
        #currentStructures {
            font-size: 16px;
            margin: 15px 0;
            text-align: left;
        }
        .progress-bar {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 5px;
            height: 10px;
            margin-top: 5px;
        }
        .progress {
            height: 100%;
            background-color: #4CAF50;
            border-radius: 5px;
            transition: width 0.3s;
        }
        .structure-item {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ELC English Speaking Trainer</h1>
        <select id="tenseSelect">
            <option value="present">Present Simple</option>
            <!-- Add more tenses later -->
        </select>
        <select id="levelSelect">
            <option value="1">Beginner Part One (Introductions and Greetings)</option>
            <option value="2">Beginner Part Two (TBD)</option>
            <option value="3">Elementary (TBD)</option>
            <option value="4">Pre-Intermediate (TBD)</option>
            <option value="5">Intermediate (TBD)</option>
            <option value="6">Upper-Intermediate (TBD)</option>
        </select>
        <div class="examples">
            <h3>Examples of words to use:</h3>
            <p id="exampleVerbs">Any name (e.g., Asel, Arman, Madina, Maksat, Maria, Piter, Natalie, Armaan)</p>
        </div>
        <div id="currentStructures">
            <h3>Structures to practice (say each 10 times):</h3>
            <ul id="structureList"></ul>
        </div>
        <button id="startButton">Start Practice</button>
        <div class="status" id="status">Progress: 0/110</div>
        <div class="status" id="listening">Press start to begin...</div>
        <div id="log">
            <h3>Practice Log:</h3>
            <div id="logEntries"></div>
        </div>
    </div>

    <script>
        const tenseSelect = document.getElementById('tenseSelect');
        const levelSelect = document.getElementById('levelSelect');
        const startButton = document.getElementById('startButton');
        const status = document.getElementById('status');
        const listening = document.getElementById('listening');
        const logEntries = document.getElementById('logEntries');
        const structureList = document.getElementById('structureList');
        const exampleVerbs = document.getElementById('exampleVerbs');

        let correctCount = 0;
        let recognition = null;
        let isListening = false;
        let saidSentences = new Set();
        let currentStructures = [];
        let structureProgress = {};

        // Define structures for each level
        const levels = {
            '1': [
                'I am ______ . (Asel, Arman, Madina, Maksat, Maria, Piter, Natalie, Armaan)',
                'You are ______ . (Asel, Arman, Madina, Maksat, Maria, Piter, Natalie, Armaan)',
                'He is ______ . (Asel, Arman, Maksat, Piter, Natalie, Armaan)',
                'She is ______ . (Asel, Madina, Mariya, Maria, Natalie, Armaan)',
                'What is your name ?',
                'What is his name ?',
                'What is her name ?',
                'My name is ______ . (Asel, Arman, Maksat, Madina, Mariya, Maria, Piter, Natalie, Armaan)',
                'His name is ______ . (Asel, Arman, Maksat, Piter, Natalie, Armaan)',
                'Her name is ______ . (Asel, Madina, Mariya, Maria, Natalie, Armaan)',
                'This is ______ . (Asel, Arman, Maksat, Madina, Mariya, Maria, Piter, Natalie, Armaan)'
            ],
            '2': [
                // Placeholder for Beginner Part Two (TBD)
                'I _______ . (work, play, eat)'
            ],
            '3': [
                // Placeholder for Elementary (TBD)
                'I _______ . (work, play, eat)'
            ],
            '4': [
                // Placeholder for Pre-Intermediate (TBD)
                'I _______ . (work, play, eat)'
            ],
            '5': [
                // Placeholder for Intermediate (TBD)
                'I _______ . (work, play, eat)'
            ],
            '6': [
                // Placeholder for Upper-Intermediate (TBD)
                'I _______ . (work, play, eat)'
            ]
        };

        // Update the displayed structures and examples
        function updateStructures() {
            const level = levelSelect.value;
            currentStructures = levels[level];

            // Initialize progress for each structure
            structureProgress = {};
            currentStructures.forEach(structure => {
                structureProgress[structure.toLowerCase()] = 0;
            });

            // Update the structure list with progress bars
            structureList.innerHTML = '';
            currentStructures.forEach(structure => {
                const li = document.createElement('li');
                li.className = 'structure-item';
                li.innerHTML = `
                    ${structure}
                    <div class="progress-bar">
                        <div class="progress" id="progress-${structure.toLowerCase().replace(/[^a-z0-9]/g, '-')}" style="width: 0%"></div>
                    </div>
                    <span id="count-${structure.toLowerCase().replace(/[^a-z0-9]/g, '-')}" style="font-size: 12px;">0/10</span>
                `;
                structureList.appendChild(li);
            });

            // Update example words
            const words = new Set();
            currentStructures.forEach(structure => {
                const match = structure.match(/\(([^)]+)\)/);
                if (match) {
                    const wordList = match[1].split(', ');
                    wordList.forEach(word => words.add(word));
                }
            });
            exampleVerbs.textContent = Array.from(words).join(', ') || 'Any name (e.g., Asel, Arman, Madina, Maksat, Maria, Piter, Natalie, Armaan)';
        }

        // Initialize speech recognition
        function initSpeechRecognition() {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onresult = (event) => {
                const spokenSentence = event.results[0][0].transcript.trim().toLowerCase();
                listening.textContent = 'Processing: ' + spokenSentence;
                checkSentence(spokenSentence);
            };

            recognition.onend = () => {
                if (isListening && correctCount < currentStructures.length * 10) {
                    recognition.start();
                    listening.textContent = 'Listening...';
                } else {
                    isListening = false;
                    listening.textContent = 'Stopped. Press start to begin...';
                    startButton.textContent = 'Start Practice';
                }
            };

            recognition.onerror = (event) => {
                listening.textContent = 'Error occurred: ' + event.error;
                isListening = false;
                startButton.textContent = 'Start Practice';
            };
        }

        // Check if the spoken sentence matches any structure in the current level
        function checkSentence(spokenSentence) {
            const tense = tenseSelect.value;
            let isCorrect = false;
            let matchedStructure = null;
            let logMessage = '';

            if (tense === 'present') {
                matchedStructure = currentStructures.find(structure => checkPresentSimpleSentence(spokenSentence, structure));
                isCorrect = !!matchedStructure;
            }

            if (saidSentences.has(spokenSentence)) {
                logMessage = `Repeat: "${spokenSentence}"`;
            } else if (isCorrect) {
                // Increment progress for the matched structure
                const structureKey = matchedStructure.toLowerCase();
                structureProgress[structureKey] = (structureProgress[structureKey] || 0) + 1;
                if (structureProgress[structureKey] <= 10) {
                    correctCount++;
                    saidSentences.add(spokenSentence);
                    logMessage = `Correct: "${spokenSentence}"`;
                    status.textContent = `Progress: ${correctCount}/${currentStructures.length * 10}`;

                    // Update progress bar and count
                    const progressBar = document.getElementById(`progress-${structureKey.replace(/[^a-z0-9]/g, '-')}`);
                    const countDisplay = document.getElementById(`count-${structureKey.replace(/[^a-z0-9]/g, '-')}`);
                    const progressPercentage = (structureProgress[structureKey] / 10) * 100;
                    progressBar.style.width = `${progressPercentage}%`;
                    countDisplay.textContent = `${structureProgress[structureKey]}/10`;
                } else {
                    logMessage = `Structure "${matchedStructure}" already completed 10 times: "${spokenSentence}"`;
                }
            } else {
                logMessage = `Incorrect: "${spokenSentence}" (wrong form or structure)`;
            }

            // Add to log
            const logEntry = document.createElement('p');
            logEntry.textContent = logMessage;
            logEntries.prepend(logEntry);

            // Stop if all structures have been said 10 times
            if (correctCount >= currentStructures.length * 10) {
                isListening = false;
                recognition.stop();
                listening.textContent = 'Congratulations! All structures completed 10 times!';
                startButton.textContent = 'Restart Practice';
            }
        }

        // Check if the spoken sentence matches the Present Simple structure
        function checkPresentSimpleSentence(spokenSentence, structure) {
            // Helper to check if a word is a valid name (any word that isn't a verb)
            function isValidName(word) {
                // Простая проверка: имя должно состоять только из букв и не быть в списке известных глаголов
                const verbIndicators = ['work', 'play', 'eat', 'like', 'love', 'want', 'is', 'are', 'am'];
                if (!/^[a-zA-Z]+$/.test(word)) return false; // Должны быть только буквы
                return !verbIndicators.includes(word.toLowerCase());
            }

            // Normalize the spoken sentence and structure (remove extra spaces and punctuation)
            const normalizeSentence = (sentence) => {
                return sentence.trim().toLowerCase().replace(/\s+/g, ' ').replace(/[?.]/g, '');
            };

            const normalizedSpokenSentence = normalizeSentence(spokenSentence);
            const spokenWords = normalizedSpokenSentence.split(' ');

            // Extract the structure without the example verbs
            const structureWithoutExamples = structure.split(' (')[0];
            const structureWords = normalizeSentence(structureWithoutExamples).split(' ');

            // Extract the expected position of the name (where ______ is)
            let namePosition = structureWords.indexOf('______');
            if (namePosition === -1) return false;

            // Adjust structure words to exclude the name slot for length comparison
            const structureWordsWithoutName = structureWords.filter(word => word !== '______');
            let expectedLength = structureWordsWithoutName.length + 1; // +1 for the name

            // Special case for questions like "What is your name ?" or "What's your name ?"
            if (structure === 'what is your name ?') {
                const expectedSentence = 'what is your name';
                const expectedSentenceShort = 'whats your name';
                return normalizedSpokenSentence === expectedSentence || normalizedSpokenSentence === expectedSentenceShort;
            } else if (structure === 'what is his name ?') {
                const expectedSentence = 'what is his name';
                const expectedSentenceShort = 'whats his name';
                return normalizedSpokenSentence === expectedSentence || normalizedSpokenSentence === expectedSentenceShort;
            } else if (structure === 'what is her name ?') {
                const expectedSentence = 'what is her name';
                const expectedSentenceShort = 'whats her name';
                return normalizedSpokenSentence === expectedSentence || normalizedSpokenSentence === expectedSentenceShort;
            }

            // Check if the spoken sentence has at least the expected number of words
            if (spokenWords.length < expectedLength - 1) return false;

            // Extract the spoken name at the correct position
            let spokenNamePosition = namePosition;
            const spokenName = spokenWords[spokenNamePosition];
            if (!spokenName) return false;

            // Verify the fixed parts of the sentence match
            let structureMatches = true;
            for (let i = 0; i < structureWords.length; i++) {
                if (i === namePosition) continue; // Skip the name slot

                let expectedWord = structureWords[i];
                let spokenWord = spokenWords[i] || '';

                if (expectedWord && expectedWord !== spokenWord) {
                    structureMatches = false;
                    break;
                }
            }

            if (!structureMatches) return false;

            // Validate the name based on the structure
            const beStructures = [
                'i am ______ . (asel, arman, madina, maksat, maria, piter, natalie, armaan)',
                'you are ______ . (asel, arman, madina, maksat, maria, piter, natalie, armaan)',
                'he is ______ . (asel, arman, maksat, piter, natalie, armaan)',
                'she is ______ . (asel, madina, mariya, maria, natalie, armaan)',
                'my name is ______ . (asel, arman, maksat, madina, mariya, maria, piter, natalie, armaan)',
                'his name is ______ . (asel, arman, maksat, piter, natalie, armaan)',
                'her name is ______ . (asel, madina, mariya, maria, natalie, armaan)',
                'this is ______ . (asel, arman, maksat, madina, mariya, maria, piter, natalie, armaan)'
            ];

            structure = structure.toLowerCase();
            if (beStructures.includes(structure)) {
                return isValidName(spokenName);
            }

            return false;
        }

        // Event listeners
        tenseSelect.addEventListener('change', () => {
            correctCount = 0;
            saidSentences.clear();
            logEntries.innerHTML = '';
            updateStructures();
            if (isListening) {
                recognition.stop();
                isListening = false;
                startButton.textContent = 'Start Practice';
                listening.textContent = 'Press start to begin...';
            }
        });

        levelSelect.addEventListener('change', () => {
            correctCount = 0;
            saidSentences.clear();
            logEntries.innerHTML = '';
            updateStructures();
            if (isListening) {
                recognition.stop();
                isListening = false;
                startButton.textContent = 'Start Practice';
                listening.textContent = 'Press start to begin...';
            }
        });

        startButton.addEventListener('click', () => {
            if (!isListening) {
                if (!recognition) initSpeechRecognition();
                isListening = true;
                recognition.start();
                startButton.textContent = 'Stop Practice';
                listening.textContent = 'Listening...';
            } else {
                isListening = false;
                recognition.stop();
                startButton.textContent = 'Start Practice';
                listening.textContent = 'Stopped. Press start to begin...';
            }
        });

        // Initialize structures
        updateStructures();
    </script>
</body>
</html>
