<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELC English Speaking Trainer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f0f0f0;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            max-width: 600px;
            width: 100%;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 80vh;
        }
        h1 {
            font-size: 24px;
            margin: 10px 0;
            text-align: center;
        }
        h2 {
            font-size: 20px;
            margin: 10px 0;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px auto;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            display: block;
        }
        button:hover {
            background-color: #45a049;
        }
        input, select {
            padding: 10px;
            font-size: 16px;
            margin: 10px 0;
            width: 100%;
            box-sizing: border-box;
        }
        .status {
            font-size: 16px;
            margin: 5px 0;
            text-align: center;
        }
        .examples {
            margin: 10px 0;
            text-align: left;
        }
        .examples h3 {
            font-size: 16px;
            margin: 5px 0;
        }
        .examples p {
            font-size: 14px;
            margin: 0;
        }
        #currentStructures {
            font-size: 16px;
            margin: 10px 0;
            text-align: left;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            flex: 1;
        }
        #currentStructures h3 {
            font-size: 18px;
            margin: 5px 0;
            color: #333;
        }
        .structure-item {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .structure-item span {
            flex: 1;
            font-size: 18px;
            color: #444;
        }
        .progress-bar {
            width: 120px;
            background-color: #f0f0f0;
            border-radius: 5px;
            height: 14px;
            margin: 0 15px;
        }
        .progress {
            height: 100%;
            background-color: #4CAF50;
            border-radius: 5px;
            transition: width 0.3s;
        }
        .count {
            font-size: 16px;
            width: 50px;
            text-align: right;
            color: #666;
        }
        #log {
            text-align: left;
            margin-top: 10px;
            padding: 5px;
            background: #e8e8e8;
            border-radius: 5px;
            transition: height 0.3s;
        }
        #log.collapsed {
            height: 25px;
            overflow: hidden;
        }
        #log.expanded {
            height: 150px;
            overflow-y: auto;
        }
        #log h3 {
            font-size: 14px;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #log p {
            font-size: 12px;
            margin: 2px 0;
        }
        #lastLogEntry {
            font-size: 12px;
            margin: 0;
            line-height: 15px;
            display: flex;
            align-items: center;
        }
        #lastLogEntry::before {
            margin-right: 5px;
            font-size: 14px;
        }
        #lastLogEntry.correct::before {
            content: "‚úÖ";
        }
        #lastLogEntry.incorrect::before {
            content: "‚ùå";
        }
        #lastLogEntry.repeat::before {
            content: "üîÅ";
        }
        #lastLogEntry.debug::before {
            content: "‚ö†Ô∏è";
        }
        #toggleLogButton {
            padding: 3px 6px;
            font-size: 10px;
            background-color: #ddd;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        #toggleLogButton:hover {
            background-color: #ccc;
        }
        #welcomeScreen, #practiceScreen {
            display: none;
        }
        #welcomeScreen.active, #practiceScreen.active {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 10px;
                height: 90vh;
            }
            h1 {
                font-size: 20px;
            }
            h2 {
                font-size: 18px;
            }
            button {
                padding: 8px 16px;
                font-size: 14px;
            }
            input, select {
                padding: 8px;
                font-size: 14px;
            }
            .status {
                font-size: 14px;
            }
            .examples h3 {
                font-size: 14px;
            }
            .examples p {
                font-size: 12px;
            }
            #currentStructures {
                font-size: 14px;
            }
            #currentStructures h3 {
                font-size: 16px;
            }
            .structure-item {
                margin-bottom: 15px;
                padding: 5px 0;
            }
            .structure-item span {
                font-size: 16px;
            }
            .progress-bar {
                width: 100px;
                height: 12px;
                margin: 0 10px;
            }
            .count {
                font-size: 14px;
                width: 40px;
            }
            #log.collapsed {
                height: 20px;
            }
            #log.expanded {
                height: 120px;
            }
            #log h3 {
                font-size: 12px;
            }
            #lastLogEntry {
                font-size: 10px;
                line-height: 12px;
            }
            #lastLogEntry::before {
                font-size: 12px;
            }
            #toggleLogButton {
                font-size: 8px;
                padding: 2px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="welcomeScreen" class="active">
            <h1>ELC English Speaking Trainer</h1>
            <input type="text" id="userName" placeholder="Enter your name" required>
            <select id="levelSelect">
                <option value="1">Beginner Part One</option>
                <option value="2">Beginner Part Two (TBD)</option>
                <option value="3">Elementary (TBD)</option>
                <option value="4">Pre-Intermediate (TBD)</option>
                <option value="5">Intermediate (TBD)</option>
                <option value="6">Upper-Intermediate (TBD)</option>
            </select>
            <select id="lessonSelect">
                <option value="1">Lesson 1: Introductions and Greetings</option>
                <!-- Add more lessons as needed -->
            </select>
            <button id="nextButton">Next</button>
        </div>
        <div id="practiceScreen">
            <h1 id="greeting"></h1>
            <h2 id="lessonTitle"></h2>
            <div class="examples">
                <h3>Task:</h3>
                <p>Say each structure 10 times to practice your English speaking skills.</p>
                <h3>Examples of words to use:</h3>
                <p id="exampleVerbs">Any name (e.g., Asel, Arman, Madina, Maksat, Maria, Piter, Natalie, Armaan)</p>
            </div>
            <div class="status" id="status">Progress: 0/50</div>
            <div class="status" id="listening">Press start to begin...</div>
            <button id="startButton">Start Practice</button>
            <div id="currentStructures">
                <h3>Structures you are practicing:</h3>
                <ul id="structureList"></ul>
            </div>
            <div id="log" class="collapsed">
                <h3>
                    Practice Log:
                    <button id="toggleLogButton">Show Log</button>
                </h3>
                <div id="lastLogEntry" class="status"></div>
                <div id="logEntries" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        const welcomeScreen = document.getElementById('welcomeScreen');
        const practiceScreen = document.getElementById('practiceScreen');
        const userNameInput = document.getElementById('userName');
        const levelSelect = document.getElementById('levelSelect');
        const lessonSelect = document.getElementById('lessonSelect');
        const nextButton = document.getElementById('nextButton');
        const greeting = document.getElementById('greeting');
        const lessonTitle = document.getElementById('lessonTitle');
        const startButton = document.getElementById('startButton');
        const status = document.getElementById('status');
        const listening = document.getElementById('listening');
        const lastLogEntry = document.getElementById('lastLogEntry');
        const logEntries = document.getElementById('logEntries');
        const toggleLogButton = document.getElementById('toggleLogButton');
        const logContainer = document.getElementById('log');
        const structureList = document.getElementById('structureList');
        const exampleVerbs = document.getElementById('exampleVerbs');

        let userName = '';
        let correctCount = 0;
        let recognition = null;
        let isListening = false;
        let saidSentences = new Set();
        let currentStructures = [];
        let structureProgress = {};
        let isLogExpanded = false;

        // Define structures for each level and lesson
        const lessons = {
            '1': {
                '1': [
                    'I am ______ . (Asel, Arman, Madina, Maksat, Maria, Piter, Natalie, Armaan)',
                    'You are ______ . (Asel, Arman, Madina, Maksat, Maria, Piter, Natalie, Armaan)',
                    'What is your name ?',
                    'My name is ______ . (Asel, Arman, Maksat, Madina, Mariya, Maria, Piter, Natalie, Armaan)',
                    'This is ______ . (Asel, Arman, Maksat, Madina, Mariya, Maria, Piter, Natalie, Armaan)'
                ]
            },
            '2': {
                '1': ['I _______ . (work, play, eat)']
            },
            '3': {
                '1': ['I _______ . (work, play, eat)']
            },
            '4': {
                '1': ['I _______ . (work, play, eat)']
            },
            '5': {
                '1': ['I _______ . (work, play, eat)']
            },
            '6': {
                '1': ['I _______ . (work, play, eat)']
            }
        };

        // Update the displayed structures and examples
        function updateStructures() {
            const level = levelSelect.value;
            const lesson = lessonSelect.value;
            currentStructures = lessons[level][lesson];

            // Initialize progress for each structure
            structureProgress = {};
            currentStructures.forEach(structure => {
                structureProgress[structure.toLowerCase()] = 0;
            });

            // Update the structure list with progress bars
            structureList.innerHTML = '';
            currentStructures.forEach(structure => {
                const li = document.createElement('li');
                li.className = 'structure-item';
                li.innerHTML = `
                    <span>${structure}</span>
                    <div class="progress-bar">
                        <div class="progress" id="progress-${structure.toLowerCase().replace(/[^a-z0-9]/g, '-')}" style="width: 0%"></div>
                    </div>
                    <span class="count" id="count-${structure.toLowerCase().replace(/[^a-z0-9]/g, '-')}" style="font-size: 12px;">0/10</span>
                `;
                structureList.appendChild(li);
            });

            // Update example words
            exampleVerbs.textContent = 'Any name (e.g., Asel, Arman, Madina, Maksat, Maria, Piter, Natalie, Armaan)';
            status.textContent = `Progress: 0/${currentStructures.length * 10}`;
        }

        // Toggle log visibility
        toggleLogButton.addEventListener('click', () => {
            isLogExpanded = !isLogExpanded;
            if (isLogExpanded) {
                logContainer.classList.remove('collapsed');
                logContainer.classList.add('expanded');
                logEntries.style.display = 'block';
                lastLogEntry.style.display = 'none';
                toggleLogButton.textContent = 'Hide Log';
            } else {
                logContainer.classList.remove('expanded');
                logContainer.classList.add('collapsed');
                logEntries.style.display = 'none';
                lastLogEntry.style.display = 'block';
                toggleLogButton.textContent = 'Show Log';
            }
        });

        // Switch to practice screen
        nextButton.addEventListener('click', () => {
            userName = userNameInput.value.trim();
            if (!userName) {
                alert('Please enter your name!');
                return;
            }
            welcomeScreen.classList.remove('active');
            practiceScreen.classList.add('active');
            greeting.textContent = `Hello, ${userName}!`;
            lessonTitle.textContent = lessonSelect.options[lessonSelect.selectedIndex].text;
            updateStructures();
            lastLogEntry.textContent = 'Press start to begin...';
            lastLogEntry.style.display = 'block';
            logContainer.style.display = 'block';
        });

        // Initialize speech recognition
        function initSpeechRecognition() {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onresult = (event) => {
                const spokenSentence = event.results[0][0].transcript.trim().toLowerCase();
                listening.textContent = 'Processing: ' + spokenSentence;
                checkSentence(spokenSentence);
            };

            recognition.onend = () => {
                if (isListening && correctCount < currentStructures.length * 10) {
                    recognition.start();
                    listening.textContent = 'Listening...';
                } else {
                    isListening = false;
                    listening.textContent = 'Stopped. Press start to begin...';
                    startButton.textContent = 'Start Practice';
                }
            };

            recognition.onerror = (event) => {
                listening.textContent = 'Error occurred: ' + event.error;
                isListening = false;
                startButton.textContent = 'Start Practice';
            };
        }

        // Check if the spoken sentence matches any structure in the current level
        function checkSentence(spokenSentence) {
            let isCorrect = false;
            let matchedStructure = null;
            let logMessage = '';
            let logClass = '';

            matchedStructure = currentStructures.find(structure => checkPresentSimpleSentence(spokenSentence, structure));
            isCorrect = !!matchedStructure;

            if (saidSentences.has(spokenSentence)) {
                logMessage = `üîÅ –ü–æ–≤—Ç–æ—Ä: "${spokenSentence}"`;
                logClass = 'repeat';
            } else if (isCorrect) {
                const structureKey = matchedStructure.toLowerCase();
                if (structureProgress[structureKey] < 10) {
                    structureProgress[structureKey]++;
                    correctCount++;
                    saidSentences.add(spokenSentence);
                    logMessage = `‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: "${spokenSentence}" (Structure: "${matchedStructure}")`;
                    logClass = 'correct';
                    status.textContent = `Progress: ${correctCount}/${currentStructures.length * 10}`;

                    // Update progress bar and count
                    const progressBar = document.getElementById(`progress-${structureKey.replace(/[^a-z0-9]/g, '-')}`);
                    const countDisplay = document.getElementById(`count-${structureKey.replace(/[^a-z0-9]/g, '-')}`);
                    const progressPercentage = (structureProgress[structureKey] / 10) * 100;
                    progressBar.style.width = `${progressPercentage}%`;
                    countDisplay.textContent = `${structureProgress[structureKey]}/10`;
                } else {
                    logMessage = `üîÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ "${matchedStructure}" —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ 10 —Ä–∞–∑: "${spokenSentence}"`;
                    logClass = 'repeat';
                }
            } else {
                logMessage = `‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: "${spokenSentence}" (–Ω–µ–≤–µ—Ä–Ω–∞—è —Ñ–æ—Ä–º–∞ –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)`;
                logClass = 'incorrect';
            }

            // Add to log
            const logEntry = document.createElement('p');
            logEntry.textContent = logMessage;
            lastLogEntry.textContent = logMessage;
            lastLogEntry.className = logClass;
            lastLogEntry.style.display = 'block';
            logEntries.prepend(logEntry);
            logContainer.style.display = 'block';

            // Stop if all structures have been said 10 times
            if (correctCount >= currentStructures.length * 10) {
                isListening = false;
                recognition.stop();
                listening.textContent = 'Congratulations! All structures completed 10 times!';
                startButton.textContent = 'Restart Practice';
            }
        }

        // Check if the spoken sentence matches the Present Simple structure
        function checkPresentSimpleSentence(spokenSentence, structure) {
            // Helper to check if a word is a valid name (any word that isn't a verb)
            function isValidName(word) {
                const verbIndicators = ['work', 'play', 'eat', 'like', 'love', 'want', 'is', 'are', 'am'];
                if (!/^[a-zA-Z]+$/.test(word)) return false; // –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã
                return !verbIndicators.includes(word.toLowerCase());
            }

            // Normalize the spoken sentence and structure (remove extra spaces and punctuation)
            const normalizeSentence = (sentence) => {
                return sentence.trim().toLowerCase().replace(/\s+/g, ' ').replace(/[?.!]/g, '');
            };

            const normalizedSpokenSentence = normalizeSentence(spokenSentence);
            const spokenWords = normalizedSpokenSentence.split(' ');

            // Extract the structure without the example verbs
            const structureWithoutExamples = structure.split(' (')[0];
            const structureWords = normalizeSentence(structureWithoutExamples).split(' ');

            // Special case for "What is your name ?" or "What's your name ?"
            if (structure === 'what is your name ?') {
                const expectedSentence = 'what is your name';
                const expectedSentenceShort = 'whats your name';
                const expectedNoSpaces = 'whatisyourname';
                const expectedAltSpelling = 'what is yur name';
                const expectedExtraSpaces = 'what  is  your  name';
                const expectedMisrecognition1 = 'what is your namee';
                const expectedMisrecognition2 = 'what isyour name';
                const expectedMisrecognition3 = 'whatis your name';
                const expectedMisrecognition4 = 'what is yourname';
                const expectedMisrecognition5 = 'what is you name';
                const expectedMisrecognition6 = 'what is yr name';
                const expectedMisrecognition7 = 'whatsyourname';
                const expectedMisrecognition8 = 'whatisyour name';
                const expectedMisrecognition9 = 'what isyourname';

                // Check for exact matches
                const exactMatches = [
                    expectedSentence,
                    expectedSentenceShort,
                    expectedNoSpaces,
                    expectedAltSpelling,
                    expectedExtraSpaces,
                    expectedMisrecognition1,
                    expectedMisrecognition2,
                    expectedMisrecognition3,
                    expectedMisrecognition4,
                    expectedMisrecognition5,
                    expectedMisrecognition6,
                    expectedMisrecognition7,
                    expectedMisrecognition8,
                    expectedMisrecognition9
                ];

                let isMatch = exactMatches.includes(normalizedSpokenSentence);

                // Check for partial match (contains key words in order)
                if (!isMatch) {
                    const keyWords = ['what', 'is', 'your', 'name'];
                    let matchIndex = 0;
                    for (const word of spokenWords) {
                        if (matchIndex < keyWords.length && word.includes(keyWords[matchIndex])) {
                            matchIndex++;
                        }
                    }
                    isMatch = matchIndex >= 3; // At least 3 keywords must match
                }

                // Check for partial match (starts with expected patterns)
                if (!isMatch) {
                    const partialPatterns = [
                        'what is your name',
                        'whats your name',
                        'what is yur name',
                        'whatisyourname',
                        'whatis your name',
                        'what isyour name',
                        'what is you name',
                        'what is yr name',
                        'whatsyourname',
                        'whatisyour name',
                        'what isyourname'
                    ];
                    isMatch = partialPatterns.some(pattern => normalizedSpokenSentence.startsWith(pattern));
                }

                if (!isMatch) {
                    console.log(`Mismatch for "What is your name ?":`);
                    console.log(`Expected one of: ${exactMatches.join(', ')}`);
                    console.log(`Got: "${normalizedSpokenSentence}"`);
                    console.log(`Spoken words: ${spokenWords.join(', ')}`);
                    console.log(`Structure words: ${structureWords.join(', ')}`);
                    const logEntry = document.createElement('p');
                    logEntry.textContent = `‚ö†Ô∏è Debug: Expected "What is your name ?" but got "${normalizedSpokenSentence}"`;
                    logEntries.prepend(logEntry);
                    lastLogEntry.textContent = `‚ö†Ô∏è Debug: Expected "What is your name ?" but got "${normalizedSpokenSentence}"`;
                    lastLogEntry.className = 'debug';
                    lastLogEntry.style.display = 'block';
                }
                return isMatch;
            }

            // Extract the expected position of the name (where ______ is)
            let namePosition = structureWords.indexOf('______');
            if (namePosition === -1) return false;

            // Adjust structure words to exclude the name slot for length comparison
            const structureWordsWithoutName = structureWords.filter(word => word !== '______');
            let expectedLength = structureWordsWithoutName.length + 1; // +1 for the name

            // Check if the spoken sentence has at least the expected number of words
            if (spokenWords.length < expectedLength - 1) return false;

            // Extract the spoken name at the correct position
            let spokenNamePosition = namePosition;
            const spokenName = spokenWords[spokenNamePosition];
            if (!spokenName) return false;

            // Verify the fixed parts of the sentence match
            let structureMatches = true;
            for (let i = 0; i < structureWords.length; i++) {
                if (i === namePosition) continue; // Skip the name slot

                let expectedWord = structureWords[i];
                let spokenWord = spokenWords[i] || '';

                if (expectedWord && expectedWord !== spokenWord) {
                    structureMatches = false;
                    break;
                }
            }

            if (!structureMatches) return false;

            // Validate the name based on the structure
            const beStructures = [
                'i am ______ . (asel, arman, madina, maksat, maria, piter, natalie, armaan)',
                'you are ______ . (asel, arman, madina, maksat, maria, piter, natalie, armaan)',
                'my name is ______ . (asel, arman, maksat, madina, mariya, maria, piter, natalie, armaan)',
                'this is ______ . (asel, arman, maksat, madina, mariya, maria, piter, natalie, armaan)'
            ];

            structure = structure.toLowerCase();
            if (beStructures.includes(structure)) {
                return isValidName(spokenName);
            }

            return false;
        }

        // Event listeners
        startButton.addEventListener('click', () => {
            if (!isListening) {
                if (!recognition) initSpeechRecognition();
                isListening = true;
                recognition.start();
                startButton.textContent = 'Stop Practice';
                listening.textContent = 'Listening...';
            } else {
                isListening = false;
                recognition.stop();
                startButton.textContent = 'Start Practice';
                listening.textContent = 'Stopped. Press start to begin...';
            }
        });
    </script>
</body>
</html>
