<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ELC English Speaking Trainer - Debug Version</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }
    #transcript {
      margin: 20px 0;
      font-size: 18px;
      color: #333;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    input[type="text"] {
      padding: 10px;
      font-size: 16px;
      margin: 10px;
      width: 300px;
    }
    #listeningIndicator {
      display: none;
      font-size: 16px;
      color: #4CAF50;
      margin: 10px 0;
    }
    .dot-pulse::after {
      content: '...';
      display: inline-block;
      animation: dotPulse 1.5s infinite;
    }
    @keyframes dotPulse {
      0% { content: '.'; }
      33% { content: '..'; }
      66% { content: '...'; }
      100% { content: '.'; }
    }
    .correct {
      color: green;
      font-weight: bold;
    }
    .incorrect {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ELC English Speaking Trainer - Debug Version</h1>
  <div>
    <button id="startButton" onclick="startPractice()">Начать практику (голос)</button>
    <div id="listeningIndicator">Слушает<span class="dot-pulse"></span></div>
    <p>Или введите предложение вручную:</p>
    <input type="text" id="manualInput" placeholder="Введите предложение">
    <button onclick="checkManualInput()">Проверить</button>
  </div>
  <p id="transcript">Составьте предложение в Present Simple.</p>

  <script>
    let recognition = null;
    let isPracticing = false;

    // Проверка доступа к микрофону
    async function checkMicAccess() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(track => track.stop());
        return true;
      } catch (err) {
        console.error('Ошибка доступа к микрофону:', err);
        return false;
      }
    }

    // Нормализация текста
    function normalizeText(spokenText) {
      spokenText = spokenText.trim().toLowerCase();
      if (spokenText.endsWith('.')) spokenText = spokenText.slice(0, -1);

      spokenText = spokenText.replace(/\bi'm\b/g, 'i am');
      spokenText = spokenText.replace(/\byou're\b/g, 'you are');
      spokenText = spokenText.replace(/\bhe's\b/g, 'he is');
      spokenText = spokenText.replace(/\bshe's\b/g, 'she is');
      spokenText = spokenText.replace(/\bit's\b/g, 'it is');
      spokenText = spokenText.replace(/\bwe're\b/g, 'we are');
      spokenText = spokenText.replace(/\bthey're\b/g, 'they are');
      spokenText = spokenText.replace(/\bdon't\b/g, 'do not');
      spokenText = spokenText.replace(/\bdoesn't\b/g, 'does not');

      // Исправление ошибок распознавания
      spokenText = spokenText.replace(/\bmyhouse\b/g, 'my house');
      spokenText = spokenText.replace(/\bsashaandanna\b/g, 'sasha and anna');
      spokenText = spokenText.replace(/\bbetterandsasha\b/g, 'better and sasha');

      console.log('Нормализованный текст:', spokenText);
      return spokenText.trim();
    }

    // Проверка Present Continuous
    function checkPresentContinuousTense(firstWord, secondWord, thirdWord) {
      if (['is', 'are', 'am'].includes(firstWord) && secondWord.endsWith('ing')) return true;
      if (['is', 'are', 'am'].includes(secondWord) && thirdWord.endsWith('ing')) return true;
      return false;
    }

    // Проверка форм "to be" в Present Simple
    function checkToBePresentTense(subject, verb) {
      const singularSubjects = ['he', 'she', 'it'];
      const pluralSubjects = ['you', 'we', 'they'];
      const isPlural = subject.includes(' and ') || subject.includes(' or ') || pluralSubjects.includes(subject);
      const isSingular = singularSubjects.includes(subject) || (!isPlural && subject !== 'i' && subject !== 'you');
      console.log('Проверка "to be": isSingular=', isSingular, 'isPlural=', isPlural, 'subject=', subject, 'verb=', verb);

      if (verb === 'is' && !isSingular) return { isCorrect: false, error: 'Неправильная форма "to be"', correction: `Используйте "are" или "am", например: "${subject} are big"` };
      if (verb === 'are' && isSingular && subject !== 'you') return { isCorrect: false, error: 'Неправильная форма "to be"', correction: `Используйте "is", например: "${subject} is big"` };
      if (verb === 'am' && subject !== 'i') return { isCorrect: false, error: 'Неправильная форма "to be"', correction: `Используйте "is" или "are", например: "${subject} is big"` };
      
      console.log('Предложение с "to be" в Present Simple распознано как корректное:', subject, verb);
      return { isCorrect: true };
    }

    // Проверка обычных глаголов в Present Simple
    function checkPresentSimpleTense(subject, verb, nextWord, words, verbIndex) {
      const singularSubjects = ['he', 'she', 'it'];
      const nonThirdPersonSubjects = ['i', 'you', 'we', 'they'];
      const isPlural = subject.includes(' and ') || subject.includes(' or ') || nonThirdPersonSubjects.includes(subject);
      const isThirdPersonSingular = singularSubjects.includes(subject) || (!isPlural && subject !== 'i' && subject !== 'you');
      console.log('Проверка Present Simple: isThirdPersonSingular=', isThirdPersonSingular, 'isPlural=', isPlural, 'subject=', subject, 'verb=', verb);

      if (verb === 'do' && nextWord === 'not') {
        if (words.length < verbIndex + 3) return { isCorrect: false, error: 'Отрицание неполное', correction: `Добавьте глагол, например: "${subject} do not like"` };
        if (isThirdPersonSingular) return { isCorrect: false, error: 'Для третьего лица единственного числа используйте "does not"', correction: `Правильно: "${subject} does not like"` };
        return { isCorrect: true };
      }
      if (verb === 'does' && nextWord === 'not') {
        if (words.length < verbIndex + 3) return { isCorrect: false, error: 'Отрицание неполное', correction: `Добавьте глагол, например: "${subject} does not like"` };
        if (!isThirdPersonSingular && subject !== 'you') return { isCorrect: false, error: 'Для подлежащих "I", "we", "they" используйте "do not"', correction: `Правильно: "${subject} do not like"` };
        return { isCorrect: true };
      }

      if (isThirdPersonSingular) {
        if (!verb.endsWith('s') && !verb.endsWith('es') && verb !== 'has' && verb !== 'goes' && verb !== 'does') {
          const correctedVerb = verb.endsWith('o') || verb.endsWith('s') || verb.endsWith('sh') || verb.endsWith('ch') || verb.endsWith('x') || verb.endsWith('z') ? `${verb}es` : `${verb}s`;
          return { isCorrect: false, error: `Отсутствует "s/es" для "${subject}"`, correction: `Правильно: "${subject} ${correctedVerb}"` };
        }
      } else {
        if ((verb.endsWith('s') || verb.endsWith('es')) && verb !== 'goes' && verb !== 'does' && !verb.endsWith('ss')) {
          return { isCorrect: false, error: `Лишнее "s/es" для "${subject}"`, correction: `Правильно: "${subject} ${verb.replace(/es$|s$/, '')}"` };
        }
      }

      console.log('Предложение в Present Simple распознано как корректное:', subject, verb);
      return { isCorrect: true };
    }

    function isPresentSimple(spokenText) {
      const normalizedText = normalizeText(spokenText);
      const words = normalizedText.split(/\s+/);
      console.log('Проверка Present Simple для:', normalizedText, 'Слова:', words);
      if (words.length < 2) return { isCorrect: false, error: 'Предложение слишком короткое', correction: 'Добавьте глагол, например: "I go"' };

      const firstWord = words[0];
      const secondWord = words[1];
      const thirdWord = words[2] || '';

      // Исключение других времен
      if (firstWord === 'will' || secondWord === 'will') return { isCorrect: false, error: 'Использовано будущее время', correction: 'Используйте Present Simple, например: "I go"' };
      if (checkPresentContinuousTense(firstWord, secondWord, thirdWord)) {
        return { isCorrect: false, error: 'Использовано Present Continuous', correction: 'Используйте Present Simple, например: "I go"' };
      }
      if (words.some(word => word.endsWith('ed'))) return { isCorrect: false, error: 'Использовано прошлое время', correction: 'Используйте Present Simple, например: "I go"' };

      // Проверка вопросов с do/does
      if (firstWord === 'do' || firstWord === 'does') {
        if (words.length < 3) return { isCorrect: false, error: 'Вопрос неполный', correction: 'Добавьте глагол, например: "Do you like?"' };
        const subject = words[1];
        const isThirdPersonSingular = ['he', 'she', 'it'].includes(subject);
        if (firstWord === 'do' && isThirdPersonSingular) return { isCorrect: false, error: 'Для третьего лица единственного числа используйте "does"', correction: `Правильно: "Does ${subject} like?"` };
        if (firstWord === 'does' && !isThirdPersonSingular && subject !== 'you') return { isCorrect: false, error: 'Для подлежащих "I", "we", "they" используйте "do"', correction: `Правильно: "Do ${subject} like?"` };
        console.log('Вопрос в Present Simple распознан как корректный:', spokenText);
        return { isCorrect: true };
      }

      // Определение подлежащего и глагола
      const subjectWords = [];
      let verbIndex = -1;
      for (let i = 0; i < words.length; i++) {
        if (['do', 'does', 'is', 'are', 'am'].includes(words[i]) || !words[i].match(/^(and|or|the|a|my|your|his|her|its|our|their)$/)) {
          verbIndex = i;
          break;
        }
        subjectWords.push(words[i]);
      }

      if (verbIndex === -1 || verbIndex >= words.length - 1) return { isCorrect: false, error: 'Предложение неполное', correction: 'Добавьте глагол, например: "I go"' };

      const subject = subjectWords.join(' ').trim();
      const verb = words[verbIndex];
      const nextWord = words[verbIndex + 1] || '';
      console.log('Подлежащее:', subject, 'Глагол:', verb, 'Следующее слово:', nextWord);

      if (subject === '') return { isCorrect: false, error: 'Отсутствует подлежащее', correction: 'Добавьте подлежащее, например: "I go"' };

      // Проверка предложений с "to be"
      if (['is', 'are', 'am'].includes(verb)) {
        return checkToBePresentTense(subject, verb);
      }

      // Проверка обычных глаголов в Present Simple
      return checkPresentSimpleTense(subject, verb, nextWord, words, verbIndex);
    }

    // Функция для проверки текста, введенного вручную
    function checkManualInput() {
      const transcript = document.getElementById('manualInput').value;
      if (transcript) {
        console.log('Ручной ввод:', transcript);
        const result = isPresentSimple(transcript);
        let message = `Вы ввели: "${transcript}"`;
        if (result.isCorrect) {
          message += ` <span class="correct">Правильно!</span>`;
        } else {
          message += ` <span class="incorrect">Неправильно!</span> Ошибка: ${result.error}. Правильно: ${result.correction}`;
        }
        document.getElementById('transcript').innerHTML = message;
      } else {
        document.getElementById('transcript').textContent = 'Введите предложение для проверки.';
      }
    }

    function toggleListeningIndicator(isListening) {
      const indicator = document.getElementById('listeningIndicator');
      indicator.style.display = isListening ? 'block' : 'none';
    }

    function startRecognition() {
      if (!isPracticing) {
        console.log('Распознавание не запущено: isPracticing = false');
        return;
      }

      if (!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) {
        alert('Ваш браузер не поддерживает распознавание речи. Используйте Google Chrome или ручной ввод.');
        console.error('SpeechRecognition не поддерживается браузером');
        return;
      }

      try {
        if (recognition) {
          recognition.stop();
          recognition = null;
        }
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.continuous = true;

        document.getElementById('transcript').textContent = `Составьте предложение в Present Simple.`;
        console.log('Ожидается предложение в Present Simple');

        recognition.onstart = function() {
          console.log('Распознавание речи успешно началось');
          toggleListeningIndicator(true);
        };

        recognition.onresult = function(event) {
          console.log('Получены результаты распознавания:', event.results);
          let transcript = '';
          for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
              transcript += event.results[i][0].transcript;
            }
          }
          transcript = transcript.trim();

          if (transcript) {
            console.log('Распознанный текст:', transcript);
            const result = isPresentSimple(transcript);
            let message = `Вы сказали: "${transcript}"`;
            if (result.isCorrect) {
              message += ` <span class="correct">Правильно!</span>`;
            } else {
              message += ` <span class="incorrect">Неправильно!</span> Ошибка: ${result.error}. Правильно: ${result.correction}`;
            }
            document.getElementById('transcript').innerHTML = message;
          } else {
            console.log('Пустой текст распознавания, пропускаем');
            document.getElementById('transcript').textContent = 'Ничего не распознано. Попробуйте снова или используйте ручной ввод.';
          }

          setTimeout(startRecognition, 2000);
        };

        recognition.onerror = function(event) {
          console.error('Ошибка распознавания речи:', event.error, event.message);
          document.getElementById('transcript').textContent = `Ошибка: ${event.error}.`;
          if (event.error === 'no-speech') {
            document.getElementById('transcript').textContent += ' Речь не обнаружена. Проверьте, включен ли микрофон, или используйте ручной ввод.';
          } else if (event.error === 'not-allowed') {
            document.getElementById('transcript').textContent += ' Доступ к микрофону запрещен. Разрешите доступ или используйте ручной ввод.';
            alert('Доступ к микрофону запрещен. Разрешите доступ в настройках браузера (рядом с URL) и перезапустите практику.');
          } else if (event.error === 'aborted') {
            document.getElementById('transcript').textContent += ' Распознавание прервано.';
          } else if (event.error === 'network') {
            document.getElementById('transcript').textContent += ' Ошибка сети. Проверьте подключение.';
          } else {
            document.getElementById('transcript').textContent += ` Ошибка: ${event.message || ''}`;
          }
        };

        recognition.onend = function() {
          console.log('Распознавание речи завершено');
          toggleListeningIndicator(false);
          if (isPracticing) {
            console.log('Перезапуск распознавания через 2 секунды');
            setTimeout(startRecognition, 2000);
          }
        };

        console.log('Запуск SpeechRecognition...');
        recognition.start();
      } catch (error) {
        console.error('Ошибка инициализации SpeechRecognition:', error);
        document.getElementById('transcript').textContent = `Ошибка инициализации: ${error.message}. Попробуйте снова или используйте ручной ввод.`;
      }
    }

    async function startPractice() {
      console.log('Запуск практики');
      const micAccess = await checkMicAccess();
      if (!micAccess) {
        alert('Не удалось получить доступ к микрофону. Разрешите доступ в настройках браузера или используйте ручной ввод.');
        console.error('Нет доступа к микрофону, практика не запущена');
        return;
      }

      if (recognition) {
        recognition.stop();
        recognition = null;
      }
      isPracticing = true;
      document.getElementById('startButton').style.display = 'none';
      startRecognition();
    }
  </script>
</body>
</html>
